// Import configuration
import { 
  GOAL_CATEGORIES, 
  TIME_CONTEXTS, 
  PRIORITY_LEVELS,
  CONTEXTUAL_TIPS,
  SPECIAL_TASKS,
  DEFAULT_USER_PREFERENCES,
  getTimeContextByHour
} from '../config/config';

// Get current time context
export const getCurrentTimeContext = () => {
  const hour = new Date().getHours();
  return getTimeContextByHour(hour).key;
};

// Check if it's weekend
export const isWeekend = () => {
  const day = new Date().getDay();
  return day === 0 || day === 6;
};

// Check if it's work hours
export const isWorkHours = () => {
  const hour = new Date().getHours();
  
  // Monday to Friday, 9 AM to 6 PM
  return !isWeekend() && hour >= 9 && hour < 18;
};

// Get contextual greeting based on time
export const getContextualGreeting = () => {
  const hour = new Date().getHours();
  const timeContext = getTimeContextByHour(hour);
  const greetings = timeContext.greeting;
  return greetings[Math.floor(Math.random() * greetings.length)];
};

// Sample work tasks
export const WORK_TASKS = [
  {
    id: 'work_bbva_time_report',
    category: GOAL_CATEGORIES.WORK.id,
    icon: '‚è∞',
    title: "BBVA Time Report",
    description: "Registrar actividades del d√≠a en bbva-timereport.appspot.com",
    time: "10 min",
    color: 'from-blue-500 to-blue-700',
    preferredTime: ['AFTERNOON', 'EVENING'],
    priority: PRIORITY_LEVELS.URGENT.id,
    recurring: true,
    tips: [
      `Abre ${SPECIAL_TASKS.timeReport.url}`,
      'Registra en qu√© features trabajaste hoy',
      'Asigna el tiempo real a cada actividad',
      'Guarda antes de cerrar la p√°gina'
    ]
  },
  {
    id: 'work_daily_standup',
    category: GOAL_CATEGORIES.WORK.id,
    icon: 'üë•',
    title: "Daily standup",
    description: "Sincronizar con el equipo sobre avances y bloqueos",
    time: "15 min",
    color: 'from-blue-500 to-blue-700',
    preferredTime: ['MORNING'],
    priority: PRIORITY_LEVELS.HIGH.id,
    recurring: true,
    tips: ['Prepara tus updates antes', 'Menciona bloqueos primero', 'S√© conciso']
  },
  {
    id: 'work_email_zero',
    category: GOAL_CATEGORIES.WORK.id,
    icon: 'üìß',
    title: "Inbox Zero",
    description: "Procesar y organizar todos los correos pendientes",
    time: "30 min",
    color: 'from-purple-500 to-purple-700',
    preferredTime: ['MORNING', 'AFTERNOON'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    tips: ['Usa la regla 2 minutos', 'Archiva lo procesado', 'Delega cuando puedas']
  },
  {
    id: 'work_deep_focus',
    category: GOAL_CATEGORIES.WORK.id,
    icon: 'üéØ',
    title: "Bloque de enfoque profundo",
    description: "Trabajar sin interrupciones en la tarea m√°s importante",
    time: "90 min",
    color: 'from-green-500 to-green-700',
    preferredTime: ['MORNING', 'AFTERNOON'],
    priority: PRIORITY_LEVELS.URGENT.id,
    tips: ['Modo avi√≥n activado', 'Cierra todas las pesta√±as', 'T√©cnica Pomodoro']
  },
  {
    id: 'work_code_review',
    category: GOAL_CATEGORIES.WORK.id,
    icon: 'üëÄ',
    title: "Code review pendiente",
    description: "Revisar PR del equipo con feedback constructivo",
    time: "45 min",
    color: 'from-indigo-500 to-indigo-700',
    preferredTime: ['AFTERNOON'],
    priority: PRIORITY_LEVELS.HIGH.id,
    tips: ['Busca edge cases', 'Sugiere mejoras', 'S√© amable en comentarios']
  },
  {
    id: 'work_documentation',
    category: GOAL_CATEGORIES.WORK.id,
    icon: 'üìù',
    title: "Actualizar documentaci√≥n",
    description: "Documentar cambios recientes del proyecto",
    time: "30 min",
    color: 'from-yellow-500 to-yellow-700',
    preferredTime: ['AFTERNOON', 'EVENING'],
    priority: PRIORITY_LEVELS.LOW.id,
    tips: ['Usa ejemplos claros', 'Incluye diagramas', 'Piensa en el pr√≥ximo dev']
  },
  {
    id: 'work_weekly_time_summary',
    category: GOAL_CATEGORIES.WORK.id,
    icon: 'üìà',
    title: "Resumen semanal de time report",
    description: "Revisar y validar las horas registradas de la semana",
    time: "15 min",
    color: 'from-indigo-500 to-indigo-700',
    preferredTime: [SPECIAL_TASKS.weeklyReview.preferredTime],
    priority: PRIORITY_LEVELS.HIGH.id,
    weeklyTask: true,
    dayOfWeek: SPECIAL_TASKS.weeklyReview.dayOfWeek,
    tips: [
      'Verifica que todos los d√≠as tengan registro',
      'Confirma que las horas sumen correctamente',
      'Identifica patrones de productividad',
      'Prepara resumen para el manager si es necesario'
    ]
  }
];

// Sample personal/health tasks
export const PERSONAL_TASKS = [
  {
    id: 'personal_meditation',
    category: GOAL_CATEGORIES.HEALTH.id,
    icon: 'üßò‚Äç‚ôÄÔ∏è',
    title: "Meditaci√≥n matutina",
    description: "5 minutos de mindfulness para empezar el d√≠a",
    time: "5 min",
    color: 'from-cyan-500 to-cyan-700',
    preferredTime: ['EARLY_MORNING', 'MORNING'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    recurring: true,
    tips: ['Encuentra un lugar tranquilo', 'Conc√©ntrate en respirar', 'No juzgues pensamientos']
  },
  {
    id: 'personal_water',
    category: GOAL_CATEGORIES.HEALTH.id,
    icon: 'üíß',
    title: "Hidrataci√≥n",
    description: "Tomar un vaso de agua - meta 8 al d√≠a",
    time: "1 min",
    color: 'from-blue-400 to-blue-600',
    preferredTime: ['MORNING', 'LUNCH', 'AFTERNOON', 'EVENING'],
    priority: PRIORITY_LEVELS.LOW.id,
    recurring: true,
    microTask: true,
    tips: ['Agua a temperatura ambiente', 'A√±ade lim√≥n si quieres', 'Alejado de comidas']
  },
  {
    id: 'personal_exercise',
    category: GOAL_CATEGORIES.HEALTH.id,
    icon: 'üèÉ‚Äç‚ôÄÔ∏è',
    title: "Sesi√≥n de ejercicio",
    description: "30 minutos de actividad f√≠sica",
    time: "30 min",
    color: 'from-red-500 to-red-700',
    preferredTime: ['MORNING', 'EVENING'],
    priority: PRIORITY_LEVELS.HIGH.id,
    tips: ['Calienta primero', 'Escucha tu cuerpo', 'Hidr√°tate bien']
  },
  {
    id: 'personal_reading',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üìö',
    title: "Lectura diaria",
    description: "Avanzar en tu libro actual",
    time: "20 min",
    color: 'from-purple-500 to-pink-600',
    preferredTime: ['LUNCH', 'EVENING', 'NIGHT'],
    priority: PRIORITY_LEVELS.LOW.id,
    tips: ['Sin distracciones', 'Toma notas si quieres', 'Disfruta el momento']
  },
  {
    id: 'personal_planning',
    category: GOAL_CATEGORIES.PERSONAL.id,
    icon: 'üìÖ',
    title: "Planificar ma√±ana",
    description: "Revisar y organizar tareas del d√≠a siguiente",
    time: "10 min",
    color: 'from-indigo-500 to-purple-600',
    preferredTime: ['EVENING', 'NIGHT'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    tips: ['Prioriza 3 importantes', 'S√© realista', 'Incluye descansos']
  },
  // History Telling Course Tasks
  {
    id: 'storytelling_morning_pages',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: '‚úçÔ∏è',
    title: "Morning Pages - Escritura libre",
    description: "3 p√°ginas de escritura libre para desbloquear creatividad narrativa",
    time: "30 min",
    color: 'from-amber-500 to-amber-700',
    preferredTime: ['EARLY_MORNING', 'MORNING'],
    priority: PRIORITY_LEVELS.HIGH.id,
    recurring: true,
    tips: [
      'No te detengas a editar', 
      'Escribe sin parar por 30 min', 
      'No hay tema incorrecto',
      'Es para liberar, no para mostrar'
    ]
  },
  {
    id: 'storytelling_story_structure',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üèóÔ∏è',
    title: "An√°lisis de estructura narrativa",
    description: "Estudiar la estructura de una historia exitosa (pel√≠cula, libro, podcast)",
    time: "45 min",
    color: 'from-indigo-500 to-indigo-700',
    preferredTime: ['AFTERNOON', 'EVENING'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    tips: [
      'Identifica los 3 actos principales',
      'Marca el punto de giro',
      'Analiza el arco del protagonista',
      'Toma notas de t√©cnicas efectivas'
    ]
  },
  {
    id: 'storytelling_character_development',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üë•',
    title: "Desarrollo de personajes",
    description: "Crear o profundizar en un personaje con backstory completo",
    time: "25 min",
    color: 'from-purple-500 to-purple-700',
    preferredTime: ['MORNING', 'AFTERNOON'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    tips: [
      'Define motivaciones profundas',
      'Crea contradicciones realistas',
      'Desarrolla su voz √∫nica',
      'Incluye detalles memorables'
    ]
  },
  {
    id: 'storytelling_voice_practice',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üéôÔ∏è',
    title: "Pr√°ctica de narraci√≥n oral",
    description: "Contar una historia en voz alta (grabar opcional)",
    time: "15 min",
    color: 'from-red-500 to-red-700',
    preferredTime: ['EVENING', 'NIGHT'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    recurring: true,
    tips: [
      'Modula tu voz seg√∫n la emoci√≥n',
      'Practica pausas dram√°ticas',
      'Usa gestos aunque nadie te vea',
      'Gr√°bate para autoevaluarte'
    ]
  },
  {
    id: 'storytelling_micro_story',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: '‚ö°',
    title: "Micro-relato del d√≠a",
    description: "Escribir una historia completa en 100 palabras o menos",
    time: "10 min",
    color: 'from-yellow-500 to-yellow-700',
    preferredTime: ['LUNCH', 'AFTERNOON', 'EVENING'],
    priority: PRIORITY_LEVELS.LOW.id,
    microTask: true,
    tips: [
      'Cada palabra debe contar',
      'Empieza in media res',
      'Implica m√°s de lo que dices',
      'Busca el giro inesperado'
    ]
  },
  {
    id: 'storytelling_sensory_details',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üëÅÔ∏è',
    title: "Ejercicio sensorial",
    description: "Describir una escena usando los 5 sentidos",
    time: "20 min",
    color: 'from-teal-500 to-teal-700',
    preferredTime: ['MORNING', 'AFTERNOON'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    tips: [
      'No solo lo visual importa',
      'Los olores evocan memorias',
      'Incluye texturas y temperaturas',
      'Sonidos ambientales dan vida'
    ]
  },
  {
    id: 'storytelling_dialogue_workshop',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üí¨',
    title: "Taller de di√°logos",
    description: "Escribir una conversaci√≥n que revele car√°cter sin decirlo",
    time: "25 min",
    color: 'from-green-500 to-green-700',
    preferredTime: ['AFTERNOON', 'EVENING'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    tips: [
      'Subtexto es clave',
      'Cada personaje habla diferente',
      'Conflicto en cada intercambio',
      'Menos tags, m√°s acci√≥n'
    ]
  },
  {
    id: 'storytelling_story_journal',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üìî',
    title: "Diario de historias cotidianas",
    description: "Capturar una an√©cdota del d√≠a con potencial narrativo",
    time: "15 min",
    color: 'from-pink-500 to-pink-700',
    preferredTime: ['EVENING', 'NIGHT'],
    priority: PRIORITY_LEVELS.LOW.id,
    recurring: true,
    tips: [
      'Busca lo extraordinario en lo ordinario',
      'Anota di√°logos reales interesantes',
      'Captura gestos y expresiones',
      'Material futuro para historias'
    ]
  },
  {
    id: 'storytelling_plot_twist',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üîÑ',
    title: "Ejercicio de giro argumental",
    description: "Tomar una historia conocida y darle un giro inesperado",
    time: "30 min",
    color: 'from-orange-500 to-orange-700',
    preferredTime: ['AFTERNOON', 'EVENING'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    tips: [
      'Subvierte expectativas l√≥gicamente',
      'El giro debe estar sembrado',
      'Cambia perspectiva del narrador',
      'Explora "¬øqu√© pasar√≠a si...?"'
    ]
  },
  {
    id: 'storytelling_emotion_mapping',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: '‚ù§Ô∏è',
    title: "Mapa emocional de escena",
    description: "Planificar el viaje emocional del lector en una escena",
    time: "20 min",
    color: 'from-rose-500 to-rose-700',
    preferredTime: ['MORNING', 'AFTERNOON'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    tips: [
      'Define emoci√≥n inicial y final',
      'Marca puntos de cambio',
      'Usa ritmo para intensificar',
      'Contraste crea impacto'
    ]
  },
  {
    id: 'storytelling_hook_practice',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üé£',
    title: "Pr√°ctica de ganchos narrativos",
    description: "Escribir 5 primeras l√≠neas irresistibles",
    time: "15 min",
    color: 'from-cyan-500 to-cyan-700',
    preferredTime: ['MORNING', 'LUNCH'],
    priority: PRIORITY_LEVELS.LOW.id,
    microTask: true,
    tips: [
      'Empieza con acci√≥n o misterio',
      'Voz √∫nica desde la primera palabra',
      'Promete conflicto inmediato',
      'Sorprende sin confundir'
    ]
  },
  {
    id: 'storytelling_world_building',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üåç',
    title: "Construcci√≥n de mundo",
    description: "Desarrollar reglas y detalles de tu universo narrativo",
    time: "40 min",
    color: 'from-emerald-500 to-emerald-700',
    preferredTime: ['EVENING', 'NIGHT'],
    priority: PRIORITY_LEVELS.MEDIUM.id,
    tips: [
      'Consistencia es credibilidad',
      'Menos exposici√≥n, m√°s inmersi√≥n',
      'Las reglas crean tensi√≥n',
      'Detalles peque√±os dan vida'
    ]
  },
  {
    id: 'storytelling_feedback_session',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'ü§ù',
    title: "Sesi√≥n de feedback",
    description: "Compartir tu historia y recibir retroalimentaci√≥n constructiva",
    time: "45 min",
    color: 'from-blue-500 to-blue-700',
    preferredTime: ['EVENING'],
    priority: PRIORITY_LEVELS.HIGH.id,
    tips: [
      'Escucha sin defender',
      'Haz preguntas espec√≠ficas',
      'Agradece toda cr√≠tica',
      'Toma notas para mejorar'
    ]
  },
  {
    id: 'storytelling_revision_deep',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: '‚úèÔ∏è',
    title: "Revisi√≥n profunda",
    description: "Editar y pulir una historia existente",
    time: "60 min",
    color: 'from-gray-500 to-gray-700',
    preferredTime: ['MORNING', 'AFTERNOON'],
    priority: PRIORITY_LEVELS.HIGH.id,
    tips: [
      'Primera pasada: estructura',
      'Segunda pasada: personajes',
      'Tercera pasada: prosa',
      'Lee en voz alta al final'
    ]
  },
  {
    id: 'storytelling_inspiration_hunt',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üîç',
    title: "Cacer√≠a de inspiraci√≥n",
    description: "Salir a observar y recolectar material para historias",
    time: "30 min",
    color: 'from-violet-500 to-violet-700',
    preferredTime: ['LUNCH', 'AFTERNOON'],
    priority: PRIORITY_LEVELS.LOW.id,
    tips: [
      'Observa sin juzgar',
      'Escucha conversaciones ajenas',
      'Fotograf√≠a detalles curiosos',
      'Preg√∫ntate "¬øy si...?"'
    ]
  }
];

// Micro tasks for breaks
export const MICRO_TASKS = [
  {
    id: 'micro_stretch',
    category: GOAL_CATEGORIES.HEALTH.id,
    icon: 'ü§∏‚Äç‚ôÄÔ∏è',
    title: "Estiramiento r√°pido",
    description: "Estira cuello, hombros y espalda",
    time: "2 min",
    color: 'from-green-400 to-green-600',
    microTask: true,
    tips: ['Lev√°ntate del escritorio', 'Respira profundo', 'Mueve el cuello suave']
  },
  {
    id: 'micro_eyes',
    category: GOAL_CATEGORIES.HEALTH.id,
    icon: 'üëÄ',
    title: "Descanso visual 20-20-20",
    description: "Mira algo a 20 pies por 20 segundos",
    time: "20 seg",
    color: 'from-blue-400 to-blue-600',
    microTask: true,
    tips: ['Mira por la ventana', 'Parpadea varias veces', 'Relaja la vista']
  },
  {
    id: 'micro_breathe',
    category: GOAL_CATEGORIES.HEALTH.id,
    icon: 'üå¨Ô∏è',
    title: "Respiraci√≥n profunda",
    description: "3 respiraciones profundas para resetear",
    time: "1 min",
    color: 'from-cyan-400 to-cyan-600',
    microTask: true,
    tips: ['Inhala por 4 segundos', 'Mant√©n por 4', 'Exhala por 6']
  },
  {
    id: 'micro_gratitude',
    category: GOAL_CATEGORIES.PERSONAL.id,
    icon: 'üôè',
    title: "Momento de gratitud",
    description: "Piensa en 3 cosas por las que agradecer",
    time: "2 min",
    color: 'from-pink-400 to-pink-600',
    microTask: true,
    tips: ['S√© espec√≠fico', 'Incluye algo peque√±o', 'Siente la gratitud']
  },
  // Storytelling Micro Tasks
  {
    id: 'micro_story_prompt',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üí≠',
    title: "Prompt creativo r√°pido",
    description: "Genera 3 ideas de historia a partir de una palabra aleatoria",
    time: "5 min",
    color: 'from-purple-400 to-purple-600',
    microTask: true,
    tips: ['No filtres ideas', 'Busca conexiones inusuales', 'Piensa en g√©neros diversos']
  },
  {
    id: 'micro_verb_upgrade',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üéØ',
    title: "Mejora de verbos",
    description: "Reemplaza 10 verbos d√©biles por verbos m√°s espec√≠ficos",
    time: "5 min",
    color: 'from-green-400 to-green-600',
    microTask: true,
    tips: ['Evita ser/estar en exceso', 'Verbos espec√≠ficos pintan escenas', 'Muestra, no cuentes']
  },
  {
    id: 'micro_title_brainstorm',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üí°',
    title: "Lluvia de t√≠tulos",
    description: "Genera 10 t√≠tulos alternativos para tu historia actual",
    time: "7 min",
    color: 'from-yellow-400 to-yellow-600',
    microTask: true,
    tips: ['Juega con aliteraciones', 'Prueba met√°foras', 'T√≠tulos cortos impactan m√°s']
  },
  {
    id: 'micro_emotion_quickwrite',
    category: GOAL_CATEGORIES.LEARNING.id,
    icon: 'üòä',
    title: "Escritura emocional express",
    description: "Escribe un p√°rrafo que transmita una emoci√≥n sin nombrarla",
    time: "8 min",
    color: 'from-red-400 to-red-600',
    microTask: true,
    tips: ['Usa lenguaje corporal', 'Ambiente refleja emoci√≥n', 'Acciones revelan sentimientos']
  }
];

// Function to get contextual tips based on category and time
export const getContextualTips = (category, timeContext) => {
  const categoryTips = CONTEXTUAL_TIPS[category];
  if (!categoryTips) {
    return {
      id: `tip_default_${Date.now()}`,
      title: "üí° Tip del momento",
      content: "Cada peque√±o paso cuenta. Sigue adelante con determinaci√≥n.",
      color: 'from-gradient-to-gradient'
    };
  }

  const contextTip = categoryTips[timeContext] || categoryTips.MORNING || {
    title: "üí° Tip del momento",
    content: "Cada peque√±o paso cuenta. Sigue adelante con determinaci√≥n."
  };
  
  return {
    id: `tip_${category}_${timeContext}_${Date.now()}`,
    ...contextTip,
    color: 'from-gradient-to-gradient'
  };
};

// Smart task distribution algorithm - SIMPLIFIED VERSION
export const getSmartTaskDistribution = (allGoals, completedTasks, userPreferences = {}) => {
  const timeContext = getCurrentTimeContext();
  const isWorkTime = isWorkHours();
  const currentDay = new Date().getDay();
  
  let eligibleTasks = [];
  
  // Collect all tasks from all active goals
  allGoals.forEach(goal => {
    if (goal.active && goal.tasks && goal.tasks.length > 0) {
      eligibleTasks.push(...goal.tasks);
    }
  });
  
  // If no tasks from goals, use default tasks
  if (eligibleTasks.length === 0) {
    console.log('No tasks from goals, using defaults');
    // Add some default tasks based on time
    if (isWorkTime) {
      eligibleTasks.push(...WORK_TASKS.slice(0, 3));
    }
    eligibleTasks.push(...PERSONAL_TASKS.slice(0, 3));
    eligibleTasks.push(...MICRO_TASKS.slice(0, 2));
  }
  
  // Filter out completed tasks
  eligibleTasks = eligibleTasks.filter(task => {
    // If it's a weekly task, only show on the specified day
    if (task.weeklyTask && task.dayOfWeek !== undefined) {
      return currentDay === task.dayOfWeek && !completedTasks.includes(task.id);
    }
    // Otherwise, filter out if completed
    return !completedTasks.includes(task.id);
  });
  
  // If all tasks are completed, show congratulations
  if (eligibleTasks.length === 0) {
    return [{
      type: 'tip',
      id: 'all_done_tip',
      title: "üéâ ¬°Felicidades!",
      content: "Has completado todas tus tareas por hoy. Descansa y disfruta tu tiempo libre.",
      color: 'from-green-400 to-green-600'
    }];
  }
  
  // Apply time context filtering (but keep at least some tasks)
  let timeFilteredTasks = eligibleTasks.filter(task => {
    // If task has preferred times, check if current time matches
    if (task.preferredTime && task.preferredTime.length > 0) {
      return task.preferredTime.includes(timeContext);
    }
    
    // Otherwise, apply smart defaults
    if (isWorkTime && task.category === GOAL_CATEGORIES.WORK.id) {
      return true;
    }
    
    if (!isWorkTime && task.category !== GOAL_CATEGORIES.WORK.id) {
      return true;
    }
    
    // Allow personal micro-tasks anytime
    if (task.microTask) {
      return true;
    }
    
    return false;
  });
  
  // If filtering removed all tasks, use unfiltered list
  if (timeFilteredTasks.length === 0) {
    timeFilteredTasks = eligibleTasks;
  }
  
  // Sort by priority
  timeFilteredTasks.sort((a, b) => {
    const priorityA = Object.values(PRIORITY_LEVELS).find(p => p.id === a.priority);
    const priorityB = Object.values(PRIORITY_LEVELS).find(p => p.id === b.priority);
    
    const orderA = priorityA ? priorityA.order : 4;
    const orderB = priorityB ? priorityB.order : 4;
    
    return orderA - orderB;
  });
  
  // Take a reasonable number of tasks
  const finalTasks = timeFilteredTasks.slice(0, 8);
  
  // Add some tips
  const result = [];
  const categories = [...new Set(finalTasks.map(t => t.category))];
  const tips = categories.map(cat => ({
    type: 'tip',
    ...getContextualTips(cat, timeContext)
  }));
  
  // Interleave tasks and tips
  finalTasks.forEach((task, index) => {
    result.push(task);
    // Add a tip every 3 tasks
    if ((index + 1) % 3 === 0 && tips.length > 0) {
      result.push(tips.shift());
    }
  });
  
  // Add remaining tips at the end
  result.push(...tips);
  
  console.log('Generated task distribution:', result);
  return result;
};

// Export everything from config that might be needed
export { GOAL_CATEGORIES, TIME_CONTEXTS, PRIORITY_LEVELS, DEFAULT_USER_PREFERENCES };
